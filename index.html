<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ramp API Connector</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    function RampConnector() {
      const [token, setToken] = useState(null);
      const [error, setError] = useState(null);
      const [loading, setLoading] = useState(false);
      
      // Ramp OAuth configuration
      // Client ID is now stored in Vercel environment variables
      // The backend will handle authentication
      const RAMP_REDIRECT_URI = window.location.origin + window.location.pathname;
      const RAMP_AUTH_URL = 'https://app.ramp.com/v1/authorize';
      const BACKEND_TOKEN_URL = '/api/auth/token';
      const BACKEND_REFRESH_URL = '/api/auth/refresh';
      
      // Client ID will be fetched from backend
      const [clientId, setClientId] = useState(null);
      
      // Check for authorization code in URL on component mount
      useEffect(() => {
        // Fetch client ID from backend
        fetchClientId();
        
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        const storedState = localStorage.getItem('ramp_oauth_state');
        
        if (code && state && state === storedState) {
          // Exchange code for token
          exchangeCodeForToken(code);
          // Clean up URL
          window.history.replaceState({}, document.title, window.location.pathname);
          localStorage.removeItem('ramp_oauth_state');
        }
        
        // Check for existing token
        const storedToken = localStorage.getItem('ramp_access_token');
        if (storedToken) {
          setToken(storedToken);
        }
      }, []);
      
      // Fetch Client ID from backend
      const fetchClientId = async () => {
        try {
          const response = await fetch('/api/config');
          if (response.ok) {
            const data = await response.json();
            setClientId(data.client_id);
          }
        } catch (err) {
          console.error('Failed to fetch config:', err);
        }
      };
      
      // Generate random state for CSRF protection
      const generateState = () => {
        return Math.random().toString(36).substring(2, 15) + 
               Math.random().toString(36).substring(2, 15);
      };
      
      // Step 1: Redirect to Ramp authorization page
      const handleRequestToken = () => {
        setError(null);
        
        if (!clientId) {
          setError('Configuration loading... Please wait or check backend setup');
          return;
        }
        
        // Generate and store state
        const state = generateState();
        localStorage.setItem('ramp_oauth_state', state);
        
        // Build authorization URL with comprehensive scopes
        const authUrl = new URL(RAMP_AUTH_URL);
        authUrl.searchParams.append('client_id', clientId);
        authUrl.searchParams.append('redirect_uri', RAMP_REDIRECT_URI);
        authUrl.searchParams.append('response_type', 'code');
        authUrl.searchParams.append('state', state);
        // Request basic read scopes
        authUrl.searchParams.append('scope', 'transactions:read cards:read users:read business:read');
        
        console.log('Redirecting to:', authUrl.toString());
        
        // Redirect to Ramp
        window.location.href = authUrl.toString();
      };
      
      // Step 2: Exchange authorization code for access token
      const exchangeCodeForToken = async (code) => {
        setLoading(true);
        setError(null);
        
        console.log('Exchanging code for token via backend...');
        
        try {
          // Call our secure backend endpoint instead of Ramp directly
          const response = await fetch(BACKEND_TOKEN_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              code: code,
              redirect_uri: RAMP_REDIRECT_URI,
            }),
          });
          
          const data = await response.json();
          
          if (!response.ok) {
            throw new Error(data.error || `HTTP ${response.status}`);
          }
          
          setToken(data.access_token);
          
          // Store tokens securely
          localStorage.setItem('ramp_access_token', data.access_token);
          if (data.refresh_token) {
            localStorage.setItem('ramp_refresh_token', data.refresh_token);
          }
          
          console.log('Token received successfully');
          
        } catch (err) {
          console.error('Token exchange error:', err);
          setError(`Failed to get token: ${err.message}`);
        } finally {
          setLoading(false);
        }
      };
      
      // Test the token by making an API call
      const testToken = async () => {
        if (!token) return;
        
        setLoading(true);
        setError(null);
        
        try {
          console.log('Testing token with API call...');
          const response = await fetch('https://api.ramp.com/developer/v1/business', {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Accept': 'application/json',
            },
          });
          
          const responseText = await response.text();
          console.log('API response:', response.status, responseText);
          
          if (!response.ok) {
            throw new Error(`API call failed: ${response.status} - ${responseText}`);
          }
          
          const data = JSON.parse(responseText);
          alert('‚úì Token works!\n\nBusiness: ' + (data.business_name_legal || data.business_name_on_card || 'N/A'));
          
        } catch (err) {
          console.error('API test error:', err);
          setError(`API test failed: ${err.message}`);
        } finally {
          setLoading(false);
        }
      };
      
      // Clear token
      const handleClearToken = () => {
        setToken(null);
        localStorage.removeItem('ramp_access_token');
        localStorage.removeItem('ramp_refresh_token');
      };
      
      // Refresh access token
      const refreshAccessToken = async () => {
        const refreshToken = localStorage.getItem('ramp_refresh_token');
        if (!refreshToken) {
          setError('No refresh token available');
          return;
        }
        
        setLoading(true);
        setError(null);
        
        try {
          const response = await fetch(BACKEND_REFRESH_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              refresh_token: refreshToken,
            }),
          });
          
          const data = await response.json();
          
          if (!response.ok) {
            throw new Error(data.error || 'Failed to refresh token');
          }
          
          setToken(data.access_token);
          localStorage.setItem('ramp_access_token', data.access_token);
          if (data.refresh_token) {
            localStorage.setItem('ramp_refresh_token', data.refresh_token);
          }
          
          alert('‚úì Token refreshed successfully!');
          
        } catch (err) {
          console.error('Token refresh error:', err);
          setError(`Failed to refresh token: ${err.message}`);
        } finally {
          setLoading(false);
        }
      };
      
      return (
        <div style={{
          maxWidth: '900px',
          margin: '40px auto',
          padding: '40px',
          fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
          backgroundColor: '#ffffff',
          borderRadius: '16px',
          boxShadow: '0 4px 20px rgba(0,0,0,0.08)'
        }}>
          <div style={{ textAlign: 'center', marginBottom: '40px' }}>
            <h1 style={{ 
              color: '#1a1a1a', 
              marginBottom: '10px',
              fontSize: '36px',
              fontWeight: '700'
            }}>
              Ramp API Connector
            </h1>
            <p style={{ 
              color: '#666', 
              fontSize: '18px',
              fontWeight: '400'
            }}>
              OAuth 2.0 Authentication Demo
            </p>
          </div>
          
          {/* Configuration notice */}
          <div style={{
            padding: '20px',
            backgroundColor: '#d1ecf1',
            border: '2px solid #17a2b8',
            borderRadius: '8px',
            marginBottom: '25px'
          }}>
            <div style={{ display: 'flex', alignItems: 'flex-start' }}>
              <span style={{ fontSize: '24px', marginRight: '10px' }}>üîê</span>
              <div>
                <strong style={{ fontSize: '16px' }}>Secure Configuration via Vercel:</strong>
                <ol style={{ marginTop: '10px', marginBottom: '0', paddingLeft: '20px' }}>
                  <li>Set <code>RAMP_CLIENT_ID</code> in Vercel Environment Variables</li>
                  <li>Set <code>RAMP_CLIENT_SECRET</code> in Vercel Environment Variables</li>
                  <li>Configure Redirect URI in <a href="https://app.ramp.com/settings/developer" target="_blank" rel="noopener" style={{ color: '#007bff' }}>Ramp Developer Settings</a></li>
                  <li>No secrets in code - everything handled securely on backend! ‚úÖ</li>
                </ol>
                {clientId && (
                  <p style={{ marginTop: '10px', marginBottom: 0, color: '#0c5460' }}>
                    <strong>Status:</strong> ‚úÖ Client ID loaded from backend
                  </p>
                )}
                {!clientId && !loading && (
                  <p style={{ marginTop: '10px', marginBottom: 0, color: '#856404' }}>
                    <strong>Status:</strong> ‚è≥ Loading configuration...
                  </p>
                )}
              </div>
            </div>
          </div>
          
          {/* Error display */}
          {error && (
            <div style={{
              padding: '20px',
              backgroundColor: '#f8d7da',
              border: '2px solid #dc3545',
              borderRadius: '8px',
              marginBottom: '25px',
              color: '#721c24'
            }}>
              <div style={{ display: 'flex', alignItems: 'flex-start' }}>
                <span style={{ fontSize: '24px', marginRight: '10px' }}>‚ùå</span>
                <div>
                  <strong>Error:</strong>
                  <div style={{ marginTop: '5px' }}>{error}</div>
                </div>
              </div>
            </div>
          )}
          
          {/* Loading state */}
          {loading && (
            <div style={{
              padding: '20px',
              backgroundColor: '#d1ecf1',
              border: '2px solid #17a2b8',
              borderRadius: '8px',
              marginBottom: '25px',
              color: '#0c5460',
              textAlign: 'center'
            }}>
              <div style={{ fontSize: '16px', fontWeight: '500' }}>‚è≥ Loading...</div>
            </div>
          )}
          
          {/* Main action area */}
          {token ? (
            <div>
              <div style={{
                padding: '25px',
                backgroundColor: '#d4edda',
                border: '2px solid #28a745',
                borderRadius: '8px',
                marginBottom: '25px'
              }}>
                <div style={{ display: 'flex', alignItems: 'center', marginBottom: '15px' }}>
                  <span style={{ fontSize: '24px', marginRight: '10px' }}>‚úÖ</span>
                  <strong style={{ color: '#155724', fontSize: '18px' }}>Access Token Received</strong>
                </div>
                <div style={{
                  marginTop: '15px',
                  padding: '15px',
                  backgroundColor: '#fff',
                  borderRadius: '6px',
                  border: '1px solid #c3e6cb',
                  fontFamily: '"Courier New", monospace',
                  fontSize: '13px',
                  wordBreak: 'break-all',
                  color: '#333',
                  maxHeight: '150px',
                  overflowY: 'auto'
                }}>
                  {token}
                </div>
                <p style={{ 
                  marginTop: '15px', 
                  marginBottom: '0',
                  fontSize: '14px', 
                  color: '#155724' 
                }}>
                  <strong>Token Type:</strong> Bearer | 
                  <strong> Expires:</strong> 10 days from issuance (as per Ramp documentation)
                </p>
              </div>
              
              <div style={{ display: 'flex', gap: '15px', flexWrap: 'wrap' }}>
                <button
                  onClick={testToken}
                  disabled={loading}
                  style={{
                    flex: '1',
                    minWidth: '200px',
                    padding: '16px 28px',
                    backgroundColor: loading ? '#6c757d' : '#007bff',
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    cursor: loading ? 'not-allowed' : 'pointer',
                    fontSize: '16px',
                    fontWeight: '600',
                    transition: 'all 0.2s',
                    boxShadow: '0 2px 8px rgba(0,123,255,0.2)'
                  }}
                  onMouseOver={(e) => !loading && (e.target.style.backgroundColor = '#0056b3')}
                  onMouseOut={(e) => !loading && (e.target.style.backgroundColor = '#007bff')}
                >
                  üß™ Test Token with API Call
                </button>
                
                <button
                  onClick={handleClearToken}
                  disabled={loading}
                  style={{
                    flex: '1',
                    minWidth: '200px',
                    padding: '16px 28px',
                    backgroundColor: loading ? '#6c757d' : '#dc3545',
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    cursor: loading ? 'not-allowed' : 'pointer',
                    fontSize: '16px',
                    fontWeight: '600',
                    transition: 'all 0.2s',
                    boxShadow: '0 2px 8px rgba(220,53,69,0.2)'
                  }}
                  onMouseOver={(e) => !loading && (e.target.style.backgroundColor = '#c82333')}
                  onMouseOut={(e) => !loading && (e.target.style.backgroundColor = '#dc3545')}
                >
                  üóëÔ∏è Clear Token
                </button>
              </div>
              
              {localStorage.getItem('ramp_refresh_token') && (
                <div style={{ marginTop: '15px' }}>
                  <button
                    onClick={refreshAccessToken}
                    disabled={loading}
                    style={{
                      width: '100%',
                      padding: '14px 24px',
                      backgroundColor: loading ? '#6c757d' : '#17a2b8',
                      color: 'white',
                      border: 'none',
                      borderRadius: '8px',
                      cursor: loading ? 'not-allowed' : 'pointer',
                      fontSize: '15px',
                      fontWeight: '600',
                      transition: 'all 0.2s',
                      boxShadow: '0 2px 8px rgba(23,162,184,0.2)'
                    }}
                    onMouseOver={(e) => !loading && (e.target.style.backgroundColor = '#138496')}
                    onMouseOut={(e) => !loading && (e.target.style.backgroundColor = '#17a2b8')}
                  >
                    üîÑ Refresh Access Token
                  </button>
                </div>
              )}
            </div>
          ) : (
            <button
              onClick={handleRequestToken}
              disabled={loading}
              style={{
                padding: '20px 40px',
                backgroundColor: loading ? '#6c757d' : '#28a745',
                color: 'white',
                border: 'none',
                borderRadius: '8px',
                cursor: loading ? 'not-allowed' : 'pointer',
                fontSize: '20px',
                fontWeight: '700',
                width: '100%',
                transition: 'all 0.2s',
                boxShadow: '0 4px 12px rgba(40,167,69,0.3)'
              }}
              onMouseOver={(e) => !loading && (e.target.style.backgroundColor = '#218838')}
              onMouseOut={(e) => !loading && (e.target.style.backgroundColor = '#28a745')}
            >
              üîê Request Access Token from Ramp
            </button>
          )}
          
          {/* Documentation */}
          <div style={{
            marginTop: '40px',
            padding: '25px',
            backgroundColor: '#f8f9fa',
            border: '2px solid #dee2e6',
            borderRadius: '8px'
          }}>
            <h3 style={{ marginTop: 0, color: '#343a40', fontSize: '20px' }}>
              üìñ How it works:
            </h3>
            <ol style={{ color: '#495057', lineHeight: '1.8' }}>
              <li><strong>Click "Request Access Token"</strong> to initiate OAuth 2.0 flow</li>
              <li><strong>Authorize on Ramp:</strong> You'll be redirected to Ramp's authorization page</li>
              <li><strong>Grant permissions:</strong> Review and approve the requested scopes</li>
              <li><strong>Redirect back:</strong> Ramp sends you back with an authorization code</li>
              <li><strong>Token exchange:</strong> Code is exchanged for an access token (should be on backend)</li>
              <li><strong>Token stored:</strong> Access token is displayed and saved in localStorage</li>
              <li><strong>Test it:</strong> Use "Test Token" to make a real API call to /business endpoint</li>
            </ol>
            
            <div style={{
              marginTop: '20px',
              padding: '15px',
              backgroundColor: '#fff3cd',
              borderRadius: '6px',
              border: '1px solid #ffc107'
            }}>
              <strong style={{ color: '#856404' }}>üîí Security Note:</strong>
              <p style={{ marginTop: '10px', marginBottom: 0, color: '#856404', fontSize: '14px' }}>
                In production, the token exchange (step 5) <strong>must</strong> happen on your 
                backend server to protect your <code>client_secret</code>. Never expose 
                your <code>client_secret</code> in frontend JavaScript code. This demo shows 
                the complete flow, but step 5 should be a backend API endpoint.
              </p>
            </div>
          </div>
          
          {/* Footer */}
          <div style={{ 
            marginTop: '30px', 
            textAlign: 'center', 
            color: '#6c757d',
            fontSize: '14px'
          }}>
            <p style={{ marginBottom: '5px' }}>
              Built with React 18 | Ramp API v1
            </p>
            <p style={{ margin: 0 }}>
              <a 
                href="https://docs.ramp.com/developer-api/v1/introduction" 
                target="_blank" 
                rel="noopener"
                style={{ color: '#007bff', textDecoration: 'none' }}
              >
                View Ramp API Documentation ‚Üí
              </a>
            </p>
          </div>
        </div>
      );
    }
    
    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<RampConnector />);
  </script>
</body>
</html>
